pipeline {
	
	triggers {
		pollSCM('*/2 * * * *')
	}
	
	agent {
		label 'nodejs'
	}

	stages {
		stage('drift check') {
			steps {
				sh'''
				oc diff -k samples/ | tee diff.txt
				! test -s diff.txt
				'''
			}
		}
	}
	post {
		success {
			sh'''
                        echo "no drift found" > no-drift.txt
                        '''
			archiveArtifacts artifacts: '*.txt'
		}

		failure {
			archiveArtifacts artifacts: 'no-drift.txt'
			build job: 'apply/main'
		}
	}
	
}
